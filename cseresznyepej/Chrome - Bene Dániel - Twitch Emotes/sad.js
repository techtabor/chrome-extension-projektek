var emoteData = [ "Kappa", "https://i.imgur.com/tiHhJbp.png",
		"KappaPride", "https://static-cdn.jtvnw.net/emoticons/v1/55338/3.0",
		"Keepo", "https://static-cdn.jtvnw.net/emoticons/v1/1902/1.0",
		"Kippa", "https://static-cdn.jtvnw.net/emoticons/v1/1901/1.0",
		"Jebaited", "https://static-cdn.jtvnw.net/emoticons/v1/114836/3.0",
		"KAPOW", "https://static-cdn.jtvnw.net/emoticons/v1/133537/3.0",
		"Kreygasm", "https://static-cdn.jtvnw.net/emoticons/v1/41/1.0",
		"LUL", "https://i.imgur.com/2EiDBoG.png",
		"PogChamp", "https://vignette.wikia.nocookie.net/kancolle/images/2/21/PogChamp_Emote.png/revision/latest?cb=20160817151144",
		"TriHard", "https://i.imgur.com/S9QSWAj.jpg",
		"4Head", "https://vignette.wikia.nocookie.net/kancolle/images/4/4f/4Head.png/revision/latest?cb=20160817131305",
		"BabyRage", "https://static-cdn.jtvnw.net/emoticons/v1/22639/1.0",
		"MingLee", "https://static-cdn.jtvnw.net/emoticons/v1/68856/3.0",
		"OneHand", "https://static-cdn.jtvnw.net/emoticons/v1/66/1.0",
		"NotLikeThis", "https://static-cdn.jtvnw.net/emoticons/v1/58765/3.0",
		"OhMyDog", "https://static-cdn.jtvnw.net/emoticons/v1/81103/3.0",
		"PJSalt", "https://static-cdn.jtvnw.net/emoticons/v1/36/1.0",
		"PraiseIt", "https://static-cdn.jtvnw.net/emoticons/v1/38586/3.0",
		"TheIlluminati", "https://static-cdn.jtvnw.net/emoticons/v1/145315/3.0",
		"WutFace", "https://static-cdn.jtvnw.net/emoticons/v1/28087/3.0",
		"cmonBruh", "https://static-cdn.jtvnw.net/emoticons/v1/84608/3.0",
		"duDudu", "https://static-cdn.jtvnw.net/emoticons/v1/62834/3.0",
		"imGlitch", "https://static-cdn.jtvnw.net/emoticons/v1/112290/3.0",
		"VoHiYo", "https://static-cdn.jtvnw.net/emoticons/v1/81274/2.0",
		"VoteYea", "https://static-cdn.jtvnw.net/emoticons/v1/106293/3.0",
		"VoteNay", "https://static-cdn.jtvnw.net/emoticons/v1/106294/3.0",
		"DansGame", "https://static-cdn.jtvnw.net/emoticons/v1/33/1.0",
		"CoolStoryBob", "https://static-cdn.jtvnw.net/emoticons/v1/123171/3.0",
		"GivePLZ", "https://static-cdn.jtvnw.net/emoticons/v1/112291/3.0",
		"EleGiggle", "https://static-cdn.jtvnw.net/emoticons/v1/4339/3.0",
		"CoolCat", "https://static-cdn.jtvnw.net/emoticons/v1/58127/3.0",
		//"Orko", "https://i.imgur.com/VNoulWM.png",
		"DxCat", "https://static-cdn.jtvnw.net/emoticons/v1/110734/3.0",
		"DarkMode", "https://static-cdn.jtvnw.net/emoticons/v1/461298/3.0",
		"BibleThump", "https://static-cdn.jtvnw.net/emoticons/v1/86/1.0",
		"BrokeBack", "https://static-cdn.jtvnw.net/emoticons/v1/4057/3.0",
		"FailFish", "https://static-cdn.jtvnw.net/emoticons/v1/360/1.0",
		"FrankerZ", "https://static-cdn.jtvnw.net/emoticons/v1/65/1.0",
		"KappaRoss", "https://static-cdn.jtvnw.net/emoticons/v1/70433/3.0",
		"MercyWing1", "https://static-cdn.jtvnw.net/emoticons/v1/1003187/3.0",
		"MercyWing2", "https://static-cdn.jtvnw.net/emoticons/v1/1003189/3.0",
		"OSFrog", "https://static-cdn.jtvnw.net/emoticons/v1/81248/3.0",
		"PowerUpL", "https://static-cdn.jtvnw.net/emoticons/v1/425688/3.0",
		"PowerUpR", "https://static-cdn.jtvnw.net/emoticons/v1/425671/3.0",
		"SwiftRage", "https://static-cdn.jtvnw.net/emoticons/v1/34/1.0",
		"SeemsGood", "https://static-cdn.jtvnw.net/emoticons/v1/64138/3.0",
		"DBstyle", "https://static-cdn.jtvnw.net/emoticons/v1/73/1.0",
		"PopCorn", "https://static-cdn.jtvnw.net/emoticons/v1/724216/3.0",
		"PunchTrees", "https://static-cdn.jtvnw.net/emoticons/v1/47/1.0",
		"SSSsss", "https://static-cdn.jtvnw.net/emoticons/v1/46/1.0",
		"ResidentSleeper", "https://static-cdn.jtvnw.net/emoticons/v1/245/1.0",
		"RitzMitz", "https://static-cdn.jtvnw.net/emoticons/v1/4338/3.0",
		"HeyGuys", "https://static-cdn.jtvnw.net/emoticons/v1/30259/3.0",
		"BloodTrail", "https://static-cdn.jtvnw.net/emoticons/v1/69/1.0",
		"BigBrother", "https://static-cdn.jtvnw.net/emoticons/v1/1904/1.0",
		"KappaWealth", "https://static-cdn.jtvnw.net/emoticons/v1/81997/3.0",
		"KappaHD", "https://static-cdn.jtvnw.net/emoticons/v1/2867/3.0",
		"MiniK", "https://static-cdn.jtvnw.net/emoticons/v1/2868/3.0" ];

var smileys = [ ":)", "https://static-cdn.jtvnw.net/jtv_user_pictures/chansub-global-emoticon-ebf60cd72f7aa600-24x18.png",
		":(", "https://static-cdn.jtvnw.net/jtv_user_pictures/chansub-global-emoticon-d570c4b3b8d8fc4d-24x18.png",
		":o", "https://static-cdn.jtvnw.net/jtv_user_pictures/chansub-global-emoticon-ae4e17f5b9624e2f-24x18.png",
		":z", "https://static-cdn.jtvnw.net/jtv_user_pictures/chansub-global-emoticon-b9cbb6884788aa62-24x18.png",
		"B)", "https://static-cdn.jtvnw.net/jtv_user_pictures/chansub-global-emoticon-2cde79cfe74c6169-24x18.png",
		":\\", "https://static-cdn.jtvnw.net/jtv_user_pictures/chansub-global-emoticon-374120835234cb29-24x18.png",
		";)", "https://static-cdn.jtvnw.net/jtv_user_pictures/chansub-global-emoticon-cfaf6eac72fe4de6-24x18.png",
		";p", "https://static-cdn.jtvnw.net/jtv_user_pictures/chansub-global-emoticon-3407bf911ad2fd4a-24x18.png",
		":p", "https://static-cdn.jtvnw.net/jtv_user_pictures/chansub-global-emoticon-e838e5e34d9f240c-24x18.png",
		"R)", "https://static-cdn.jtvnw.net/jtv_user_pictures/chansub-global-emoticon-0536d670860bf733-24x18.png",
		"o_O", "https://static-cdn.jtvnw.net/jtv_user_pictures/chansub-global-emoticon-8e128fa8dc1de29c-24x18.png",
		":D", "https://static-cdn.jtvnw.net/jtv_user_pictures/chansub-global-emoticon-9f2ac5d4b53913d7-24x18.png",
		"&gt;(", "https://static-cdn.jtvnw.net/jtv_user_pictures/chansub-global-emoticon-d31223e81104544a-24x18.png",
		"&lt;3", "https://static-cdn.jtvnw.net/jtv_user_pictures/chansub-global-emoticon-577ade91d46d7edc-24x18.png" ];
		

var oldTXT  = "";
var invert = false;
var smiley = true;
// Kappa 
function replaceStringNoHTML(original, source, dest)
{
	// Instead of replace() I'm going to make my own replace function, so that it can ignore HTML tags.
	var output = original;
	var ignore = 0;
	var patternindex = 0;
	for (var i = 0; i < output.length; i++)
	{
		if (output[i] == ">")
		{
			if (ignore != 2 && ignore != 4)
				ignore = 0;
		}
		if (output[i] == source[patternindex] && ignore == 0)
		{
			if (++patternindex == source.length)
			{
				i -= patternindex;
				var tmp = output.substring(0, i);
				output = tmp + output.substring(i).replace(source, dest); // replaces it once then adds the previous string back
			}
		}
		else if (ignore == 1)
		{
			if (output[i - 1] == "<" && output[i].toLowerCase() == "s" && output[i + 1].toLowerCase() == "c")
			{
				ignore = 2;
			}
			if (output[i - 1] == "<" && output[i].toLowerCase() == "f" && output[i + 1].toLowerCase() == "o")
			{
				ignore = 4;
			}
		}
		else if (ignore == 2)
		{
			if (output[i] == "<" && output[i + 1] == "/" && output[i + 2].toLowerCase() == "s")
			{
				ignore = 3;
			}
		}
		else if (ignore == 4)
		{
			if (output[i] == "<" && output[i + 1] == "/" && output[i + 2].toLowerCase() == "f" && output[i + 3].toLowerCase() == "o")
			{
				ignore = 5;
			}
		}
		else
		{
			patternindex = 0;
		}
		if (output[i] == "<" && ignore == 0) ignore = 1;
	}
	return output;
}

function doEmotes(element, emotes)
{
	var txt = element.innerHTML;
	for (var j = 0; j < emotes.length; j += 2)
	{
		var ename = emotes[j];
		var url = "<img src=\"" + emotes[j + 1] + "\" style=\"width: auto !important; height: " + (emotes == smileys ? 18 : 32) + "px !important; float: none !important; clear: none !important; vertical-align: unset !important; display: inline !important;" + (invert ? " filter: invert(100%);" : "") + "\" title=\"" + ename + "\">";
		if (txt == ename)
			txt = url;
		else {
			if (txt.startsWith(ename + " "))
			{
				txt = txt.replace(ename + " ", url + " ");
			}
			txt = replaceStringNoHTML(txt, " " + ename + " ", " " + url + " ");
			txt = replaceStringNoHTML(txt, ">" + ename + " ", ">" + url + " ");
			txt = replaceStringNoHTML(txt, " " + ename + "<", " " + url + "<");
			txt = replaceStringNoHTML(txt, ">" + ename + "<", ">" + url + "<");
			if (txt.endsWith(" " + ename))
			{
				txt = txt.replace(" " + ename, " " + url);
			}
		}
	}
	if (element.innerHTML != txt)
		element.innerHTML = txt;
}

function underBody(child, parent)
{
	var e = child;
	while (e.parentNode != null)
	{
		e = e.parentNode;
		if (e == parent) return true;
	}
	return false;
}
function underElementType(child, type)
{
	var e = child;
	while (e.parentNode != null)
	{
		e = e.parentNode;
		if (e.nodeName == type) return true;
	}
	return false;
}

function replaceEmotes()
{
	console.log("replaceEmotes() call");
	if (document.body.innerHTML != oldTXT) {
		var allowedTags = [ "p", "a", "h1", "h2", "h3", "h4", "h5", "h6", "font", "div", "span", "center", "b", "strong", "i", "label" ];
		for (var j = 0; j < allowedTags.length; j++)
		{
			var gonsz = document.body.getElementsByTagName(allowedTags[j]);
			for (var i = 0; i < gonsz.length; i++) {
				var gonsz2 = gonsz[i].childNodes;
				var text = [].reduce.call(gonsz2, function(a, b) { return a + (b.nodeType == 3 ? b.textContent : ""); }, '').trim();
				if (text.length > 0) {
					var hasScript = false;
					for (var ij = 0; ij < gonsz2.length; ij++) {
						if (gonsz2[ij].nodeName == "SCRIPT") {
							hasScript = true;
							break;
						}
					}
					if (!hasScript && !underElementType(gonsz[i], "FORM")) {
						doEmotes(gonsz[i], emoteData);
						if (smiley) doEmotes(gonsz[i], smileys);
					}
				}
			}
		}
		oldTXT = document.body.innerHTML;
	}
}

setTimeout(replaceEmotes, 50);